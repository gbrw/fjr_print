<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة تفاعلية</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .controls {
            flex: 1;
            min-width: 500px;
        }
        
        .preview-container {
            flex: 1;
            min-width: 400px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .group-box {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .group-box h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #444;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .form-row label {
            width: 100px;
            margin-left: 10px;
        }
        
        .form-row input,
        .form-row select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .preview {
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 400px;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: auto;
        }
        
        .preview-content {
            margin-bottom: 15px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button.secondary {
            background-color: #2196F3;
        }
        
        button.tertiary {
            background-color: #9E9E9E;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        /* تنسيقات الطباعة الأساسية (لكلا الاتجاهين) */
        @media print {
            html, body {
                margin: 0;
                padding: 0;
            }
            
            /* إجبار المتصفح على طباعة الخلفيات والألوان */
            html {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background-color: white;
            }
            
            .controls, .autosave-indicator, .message {
                display: none !important;
            }
            
            .container {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .preview-container {
                width: 100% !important;
                height: 100% !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
            }
            
            .preview {
                border: none !important;
                box-shadow: none !important;
                width: 100% !important;
                height: 100% !important;
                padding: 10mm !important;
                margin: 0 !important;
                min-height: auto !important;
            }
            
            .group-box {
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .group-box h2 {
                display: none !important;
            }

            .preview-background {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background-size: cover !important;
                background-position: center !important;
                display: block !important;
                visibility: visible !important;
                z-index: 0 !important;
            }
            
            .preview-content {
                position: relative !important;
                z-index: 1 !important;
            }
        }
        
        /* تنسيق الطباعة للورقة العمودية */
        .page-vertical {
            page: portrait;
        }
        
        @page portrait {
            size: A4 portrait;
        }
        
        @media print and (orientation: portrait) {
            .print-content {
                width: 210mm;
                height: 297mm;
            }
        }
        
        /* تنسيق الطباعة للورقة الأفقية */
        .page-horizontal {
            page: landscape;
        }
        
        @page landscape {
            size: A4 landscape;
        }
        
        @media print and (orientation: landscape) {
            .print-content {
                width: 297mm;
                height: 210mm;
            }
        }
        
        /* التوجيه الأفقي والعمودي للمعاينة */
        .horizontal-layout {
            display: flex;
            flex-direction: row;
            gap: 15px;
        }

        .vertical-layout {
            display: flex;
            flex-direction: column;
        }

        /* تخصيص شريط التمرير للشفافية */
        input[type="range"] {
            width: 100%;
        }

        /* خصائص إضافية للمعاينة */
        .preview-wrapper {
            position: relative;
            height: 100%;
        }

        .preview-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .preview-content {
            position: relative;
            z-index: 1;
        }
        
        /* نافذة الرسائل */
        .message {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s, fadeOut 0.3s 2s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* مؤشر الحفظ التلقائي */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 1000;
        }

        .autosave-indicator.saving {
            color: #ffeb3b;
        }
        
        /* معاينة الطباعة */
        .print-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            overflow: auto;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .print-preview.active {
            display: flex;
        }
        
        .print-preview-content {
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            margin: 20px;
        }
        
        .print-preview-content.portrait {
            width: 210mm;
            height: 297mm;
            max-height: 80vh;
            max-width: 80vw;
            aspect-ratio: 210/297;
        }
        
        .print-preview-content.landscape {
            width: 297mm;
            height: 210mm;
            max-height: 80vh;
            max-width: 80vw;
            aspect-ratio: 297/210;
        }
        
        .print-preview-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .print-preview .close-btn {
            background-color: #f44336;
        }
        
        .print-preview .print-btn {
            background-color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="message" id="message">تم حفظ الإعدادات بنجاح</div>
    <div class="autosave-indicator" id="autosave-indicator">آخر حفظ تلقائي: لم يتم الحفظ بعد</div>
    <div class="container">
        <div class="controls">
            <!-- قسم العرض -->
            <div class="group-box">
                <h2>العرض</h2>
                <div class="form-row">
                    <label for="title-text">النص:</label>
                    <input type="text" id="title-text" value="عنوان العرض">
                </div>
                <div class="form-row">
                    <label for="title-font">نوع الخط:</label>
                    <select id="title-font">
                        <option value="Arial">Arial</option>
                        <option value="'Segoe UI'">Segoe UI</option>
                        <option value="'Times New Roman'">Times New Roman</option>
                        <option value="'Courier New'">Courier New</option>
                        <option value="Tahoma">Tahoma</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="title-size">حجم الخط:</label>
                    <input type="number" id="title-size" min="10" max="72" value="24">
                </div>
                <div class="form-row">
                    <label for="title-color">اللون:</label>
                    <select id="title-color">
                        <option value="black">أسود</option>
                        <option value="red">أحمر</option>
                        <option value="blue">أزرق</option>
                        <option value="green">أخضر</option>
                        <option value="#800080">بنفسجي</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>خصائص النص:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="title-bold">
                            <label for="title-bold">غامق</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="title-italic">
                            <label for="title-italic">مائل</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="title-underline">
                            <label for="title-underline">تحته خط</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label>المحاذاة:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="title-align" id="title-align-right" value="right" checked>
                            <label for="title-align-right">يمين</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="title-align" id="title-align-center" value="center">
                            <label for="title-align-center">وسط</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="title-align" id="title-align-left" value="left">
                            <label for="title-align-left">يسار</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم المنتج -->
            <div class="group-box">
                <h2>المنتج</h2>
                <div class="form-row">
                    <label for="product-text">النص:</label>
                    <input type="text" id="product-text" value="اسم المنتج">
                </div>
                <div class="form-row">
                    <label for="product-font">نوع الخط:</label>
                    <select id="product-font">
                        <option value="Arial">Arial</option>
                        <option value="'Segoe UI'" selected>Segoe UI</option>
                        <option value="'Times New Roman'">Times New Roman</option>
                        <option value="'Courier New'">Courier New</option>
                        <option value="Tahoma">Tahoma</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="product-size">حجم الخط:</label>
                    <input type="number" id="product-size" min="10" max="72" value="18">
                </div>
                <div class="form-row">
                    <label for="product-color">اللون:</label>
                    <select id="product-color">
                        <option value="black">أسود</option>
                        <option value="red">أحمر</option>
                        <option value="blue" selected>أزرق</option>
                        <option value="green">أخضر</option>
                        <option value="#800080">بنفسجي</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>خصائص النص:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="product-bold" checked>
                            <label for="product-bold">غامق</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="product-italic">
                            <label for="product-italic">مائل</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="product-underline">
                            <label for="product-underline">تحته خط</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label>المحاذاة:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="product-align" id="product-align-right" value="right" checked>
                            <label for="product-align-right">يمين</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="product-align" id="product-align-center" value="center">
                            <label for="product-align-center">وسط</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="product-align" id="product-align-left" value="left">
                            <label for="product-align-left">يسار</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم السعر -->
            <div class="group-box">
                <h2>السعر</h2>
                <div class="form-row">
                    <label for="price-text">النص:</label>
                    <input type="text" id="price-text" value="99.99 ريال">
                </div>
                <div class="form-row">
                    <label for="price-font">نوع الخط:</label>
                    <select id="price-font">
                        <option value="Arial">Arial</option>
                        <option value="'Segoe UI'">Segoe UI</option>
                        <option value="'Times New Roman'">Times New Roman</option>
                        <option value="'Courier New'" selected>Courier New</option>
                        <option value="Tahoma">Tahoma</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="price-size">حجم الخط:</label>
                    <input type="number" id="price-size" min="10" max="72" value="20">
                </div>
                <div class="form-row">
                    <label for="price-color">اللون:</label>
                    <select id="price-color">
                        <option value="black">أسود</option>
                        <option value="red" selected>أحمر</option>
                        <option value="blue">أزرق</option>
                        <option value="green">أخضر</option>
                        <option value="#800080">بنفسجي</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>خصائص النص:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="price-bold" checked>
                            <label for="price-bold">غامق</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="price-italic">
                            <label for="price-italic">مائل</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="price-underline">
                            <label for="price-underline">تحته خط</label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label>المحاذاة:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="price-align" id="price-align-right" value="right">
                            <label for="price-align-right">يمين</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="price-align" id="price-align-center" value="center" checked>
                            <label for="price-align-center">وسط</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="price-align" id="price-align-left" value="left">
                            <label for="price-align-left">يسار</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم الخلفية -->
            <div class="group-box">
                <h2>الخلفية</h2>
                <div class="form-row">
                    <label for="background-image">صورة الخلفية:</label>
                    <input type="file" id="background-image" accept="image/*">
                </div>
                <div class="form-row">
                    <label for="background-opacity">الشفافية:</label>
                    <input type="range" id="background-opacity" min="0" max="1" step="0.1" value="1">
                </div>
            </div>

            <!-- قسم إعدادات الصفحة -->
            <div class="group-box">
                <h2>إعدادات الصفحة</h2>
                <div class="form-row">
                    <label>اتجاه الصفحة:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="page-orientation" id="orientation-vertical" value="vertical" checked>
                            <label for="orientation-vertical">عمودي</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="page-orientation" id="orientation-horizontal" value="horizontal">
                            <label for="orientation-horizontal">أفقي</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- أزرار الطباعة والحفظ -->
            <div class="btn-group">
                <button id="print-btn">معاينة الطباعة</button>
                <button id="save-btn" class="secondary">حفظ الإعدادات</button>
                <button id="load-btn" class="tertiary">استرجاع الإعدادات</button>
            </div>
        </div>

        <!-- قسم المعاينة -->
        <div class="preview-container">
            <div class="group-box">
                <h2>المعاينة</h2>
                <div class="preview">
                    <div class="preview-wrapper">
                        <div class="preview-background"></div>
                        <div class="preview-content">
                            <div id="preview-title"></div>
                            <div id="preview-product"></div>
                            <div id="preview-price"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة الطباعة -->
    <div class="print-preview" id="print-preview">
        <div class="print-preview-content portrait" id="print-preview-content">
            <div class="preview-wrapper">
                <div class="preview-background" id="preview-background-print"></div>
                <div class="preview-content">
                    <div id="preview-title-print"></div>
                    <div id="preview-product-print"></div>
                    <div id="preview-price-print"></div>
                </div>
            </div>
        </div>
        <div class="print-preview-actions">
            <button id="print-now-btn" class="print-btn">طباعة</button>
            <button id="close-preview-btn" class="close-btn">إغلاق</button>
        </div>
    </div>

    <script>
        // الحصول على جميع عناصر التحكم
        const titleText = document.getElementById('title-text');
        const titleFont = document.getElementById('title-font');
        const titleSize = document.getElementById('title-size');
        const titleColor = document.getElementById('title-color');
        const titleBold = document.getElementById('title-bold');
        const titleItalic = document.getElementById('title-italic');
        const titleUnderline = document.getElementById('title-underline');
        const titleAlignRadios = document.querySelectorAll('input[name="title-align"]');

        const productText = document.getElementById('product-text');
        const productFont = document.getElementById('product-font');
        const productSize = document.getElementById('product-size');
        const productColor = document.getElementById('product-color');
        const productBold = document.getElementById('product-bold');
        const productItalic = document.getElementById('product-italic');
        const productUnderline = document.getElementById('product-underline');
        const productAlignRadios = document.querySelectorAll('input[name="product-align"]');

        const priceText = document.getElementById('price-text');
        const priceFont = document.getElementById('price-font');
        const priceSize = document.getElementById('price-size');
        const priceColor = document.getElementById('price-color');
        const priceBold = document.getElementById('price-bold');
        const priceItalic = document.getElementById('price-italic');
        const priceUnderline = document.getElementById('price-underline');
        const priceAlignRadios = document.querySelectorAll('input[name="price-align"]');

        const backgroundImage = document.getElementById('background-image');
        const backgroundOpacity = document.getElementById('background-opacity');
        const orientationRadios = document.querySelectorAll('input[name="page-orientation"]');
        
        const printBtn = document.getElementById('print-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const messageEl = document.getElementById('message');
        const autosaveIndicator = document.getElementById('autosave-indicator');

        // عناصر معاينة الطباعة
        const printPreviewModal = document.getElementById('print-preview');
        const printPreviewContent = document.getElementById('print-preview-content');
        const printNowBtn = document.getElementById('print-now-btn');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewTitlePrint = document.getElementById('preview-title-print');
        const previewProductPrint = document.getElementById('preview-product-print');
        const previewPricePrint = document.getElementById('preview-price-print');
        const previewBackgroundPrint = document.getElementById('preview-background-print');

        // عناصر المعاينة
        const previewTitle = document.getElementById('preview-title');
        const previewProduct = document.getElementById('preview-product');
        const previewPrice = document.getElementById('preview-price');
        const previewBackground = document.querySelector('.preview-background');
        const previewWrapper = document.querySelector('.preview-wrapper');
        const preview = document.querySelector('.preview');

        // متغيرات للحفظ التلقائي
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 2000; // تأخير الحفظ التلقائي بالمللي ثانية (2 ثوان)
        let lastAutoSaveTime = null;

        // متغير لتخزين البيانات المحملة من الصورة
        let backgroundImageData = '';

        // دالة تحديث المعاينة
        function updatePreview() {
            // تحديث عنوان العرض
            previewTitle.textContent = titleText.value;
            previewTitle.style.fontFamily = titleFont.value;
            previewTitle.style.fontSize = titleSize.value + 'px';
            previewTitle.style.color = titleColor.value;
            previewTitle.style.fontWeight = titleBold.checked ? 'bold' : 'normal';
            previewTitle.style.fontStyle = titleItalic.checked ? 'italic' : 'normal';
            previewTitle.style.textDecoration = titleUnderline.checked ? 'underline' : 'none';
            
            let titleAlign = 'right';
            for (const radio of titleAlignRadios) {
                if (radio.checked) {
                    titleAlign = radio.value;
                    break;
                }
            }
            previewTitle.style.textAlign = titleAlign;

            // تحديث المنتج
            previewProduct.textContent = productText.value;
            previewProduct.style.fontFamily = productFont.value;
            previewProduct.style.fontSize = productSize.value + 'px';
            previewProduct.style.color = productColor.value;
            previewProduct.style.fontWeight = productBold.checked ? 'bold' : 'normal';
            previewProduct.style.fontStyle = productItalic.checked ? 'italic' : 'normal';
            previewProduct.style.textDecoration = productUnderline.checked ? 'underline' : 'none';
            
            let productAlign = 'right';
            for (const radio of productAlignRadios) {
                if (radio.checked) {
                    productAlign = radio.value;
                    break;
                }
            }
            previewProduct.style.textAlign = productAlign;

            // تحديث السعر
            previewPrice.textContent = priceText.value;
            previewPrice.style.fontFamily = priceFont.value;
            previewPrice.style.fontSize = priceSize.value + 'px';
            previewPrice.style.color = priceColor.value;
            previewPrice.style.fontWeight = priceBold.checked ? 'bold' : 'normal';
            previewPrice.style.fontStyle = priceItalic.checked ? 'italic' : 'normal';
            previewPrice.style.textDecoration = priceUnderline.checked ? 'underline' : 'none';
            
            let priceAlign = 'right';
            for (const radio of priceAlignRadios) {
                if (radio.checked) {
                    priceAlign = radio.value;
                    break;
                }
            }
            previewPrice.style.textAlign = priceAlign;

            // تحديث الشفافية
            previewBackground.style.opacity = backgroundOpacity.value;

            // تحديث اتجاه الصفحة
            let orientation = 'vertical';
            for (const radio of orientationRadios) {
                if (radio.checked) {
                    orientation = radio.value;
                    break;
                }
            }

            if (orientation === 'horizontal') {
                preview.style.display = 'flex';
                preview.style.flexDirection = 'row';
                preview.style.alignItems = 'center';
                preview.style.justifyContent = 'space-around';
                preview.style.minHeight = '200px';
            } else {
                preview.style.display = 'block';
                preview.style.minHeight = '400px';
            }
            
            // تحديث نسخة معاينة الطباعة أيضًا إذا كانت مفتوحة
            updatePrintPreview();

            // جدولة الحفظ التلقائي بعد التغيير
            scheduleAutoSave();
        }

        // دالة لتحديث معاينة الطباعة
        function updatePrintPreview() {
            // نسخ جميع التنسيقات من المعاينة الرئيسية إلى معاينة الطباعة
            previewTitlePrint.textContent = titleText.value;
            previewTitlePrint.style.fontFamily = titleFont.value;
            previewTitlePrint.style.fontSize = titleSize.value + 'px';
            previewTitlePrint.style.color = titleColor.value;
            previewTitlePrint.style.fontWeight = titleBold.checked ? 'bold' : 'normal';
            previewTitlePrint.style.fontStyle = titleItalic.checked ? 'italic' : 'normal';
            previewTitlePrint.style.textDecoration = titleUnderline.checked ? 'underline' : 'none';
            previewTitlePrint.style.textAlign = getSelectedRadioValue(titleAlignRadios);

            previewProductPrint.textContent = productText.value;
            previewProductPrint.style.fontFamily = productFont.value;
            previewProductPrint.style.fontSize = productSize.value + 'px';
            previewProductPrint.style.color = productColor.value;
            previewProductPrint.style.fontWeight = productBold.checked ? 'bold' : 'normal';
            previewProductPrint.style.fontStyle = productItalic.checked ? 'italic' : 'normal';
            previewProductPrint.style.textDecoration = productUnderline.checked ? 'underline' : 'none';
            previewProductPrint.style.textAlign = getSelectedRadioValue(productAlignRadios);

            previewPricePrint.textContent = priceText.value;
            previewPricePrint.style.fontFamily = priceFont.value;
            previewPricePrint.style.fontSize = priceSize.value + 'px';
            previewPricePrint.style.color = priceColor.value;
            previewPricePrint.style.fontWeight = priceBold.checked ? 'bold' : 'normal';
            previewPricePrint.style.fontStyle = priceItalic.checked ? 'italic' : 'normal';
            previewPricePrint.style.textDecoration = priceUnderline.checked ? 'underline' : 'none';
            previewPricePrint.style.textAlign = getSelectedRadioValue(priceAlignRadios);

            // نسخ الخلفية
            if (backgroundImageData) {
                previewBackgroundPrint.style.backgroundImage = `url(${backgroundImageData})`;
            } else {
                previewBackgroundPrint.style.backgroundImage = 'none';
            }
            previewBackgroundPrint.style.opacity = backgroundOpacity.value;

            // تحديث اتجاه الصفحة
            const orientation = getSelectedRadioValue(orientationRadios);
            if (orientation === 'horizontal') {
                printPreviewContent.className = 'print-preview-content landscape';
            } else {
                printPreviewContent.className = 'print-preview-content portrait';
            }
        }

        // دالة فتح نافذة معاينة الطباعة
        function showPrintPreview() {
            updatePrintPreview();
            printPreviewModal.classList.add('active');
        }

        // دالة إغلاق نافذة معاينة الطباعة
        function closePrintPreview() {
            printPreviewModal.classList.remove('active');
        }

        // دالة الطباعة الفعلية
        function printDocument() {
            // إنشاء عنصر iframe مؤقت للطباعة
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // الحصول على محتوى الصفحة
            const orientation = getSelectedRadioValue(orientationRadios);
            let pageClass = orientation === 'horizontal' ? 'page-horizontal' : 'page-vertical';
            
            // بناء HTML محتوى الطباعة
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة</title>
                    <style>
                        @page {
                            size: A4 ${orientation === 'horizontal' ? 'landscape' : 'portrait'};
                            margin: 0;
                        }
                        
                        body {
                            margin: 0;
                            padding: 20mm;
                            width: ${orientation === 'horizontal' ? '297mm' : '210mm'};
                            height: ${orientation === 'horizontal' ? '210mm' : '297mm'};
                            overflow: hidden;
                            position: relative;
                        }

                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            box-sizing: border-box;
                        }
                        
                        .preview-wrapper {
                            position: relative;
                            width: 100%;
                            height: 100%;
                        }
                        
                        .preview-background {
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-image: ${previewBackgroundPrint.style.backgroundImage};
                            background-size: cover;
                            background-position: center;
                            opacity: ${backgroundOpacity.value};
                            z-index: 0;
                        }
                        
                        .preview-content {
                            position: relative;
                            z-index: 1;
                        }
                        
                        #preview-title-print {
                            font-family: ${titleFont.value};
                            font-size: ${titleSize.value}px;
                            color: ${titleColor.value};
                            font-weight: ${titleBold.checked ? 'bold' : 'normal'};
                            font-style: ${titleItalic.checked ? 'italic' : 'normal'};
                            text-decoration: ${titleUnderline.checked ? 'underline' : 'none'};
                            text-align: ${getSelectedRadioValue(titleAlignRadios)};
                            margin-bottom: 20px;
                        }
                        
                        #preview-product-print {
                            font-family: ${productFont.value};
                            font-size: ${productSize.value}px;
                            color: ${productColor.value};
                            font-weight: ${productBold.checked ? 'bold' : 'normal'};
                            font-style: ${productItalic.checked ? 'italic' : 'normal'};
                            text-decoration: ${productUnderline.checked ? 'underline' : 'none'};
                            text-align: ${getSelectedRadioValue(productAlignRadios)};
                            margin-bottom: 20px;
                        }
                        
                        #preview-price-print {
                            font-family: ${priceFont.value};
                            font-size: ${priceSize.value}px;
                            color: ${priceColor.value};
                            font-weight: ${priceBold.checked ? 'bold' : 'normal'};
                            font-style: ${priceItalic.checked ? 'italic' : 'normal'};
                            text-decoration: ${priceUnderline.checked ? 'underline' : 'none'};
                            text-align: ${getSelectedRadioValue(priceAlignRadios)};
                        }
                        
                        ${orientation === 'horizontal' ? `
                        .preview-content {
                            display: flex;
                            flex-direction: row;
                            justify-content: space-around;
                            align-items: center;
                            height: 100%;
                        }
                        
                        #preview-title-print, #preview-product-print, #preview-price-print {
                            margin: 0 20px;
                            flex: 1;
                        }` : ''}
                    </style>
                </head>
                <body class="${pageClass}">
                    <div class="preview-wrapper">
                        <div class="preview-background"></div>
                        <div class="preview-content">
                            <div id="preview-title-print">${titleText.value}</div>
                            <div id="preview-product-print">${productText.value}</div>
                            <div id="preview-price-print">${priceText.value}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // إضافة المحتوى إلى الإطار
            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(printContent);
            iframeDoc.close();
            
            // انتظار تحميل الخلفية إذا وجدت
            setTimeout(() => {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
                
                // إزالة الإطار بعد الطباعة
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 100);
            }, 500); // انتظار لتحميل الصور
        }

        // دالة جدولة الحفظ التلقائي
        function scheduleAutoSave() {
            // إلغاء أي مؤقت سابق للحفظ التلقائي
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // عرض مؤشر "جاري الحفظ..."
            autosaveIndicator.textContent = "جاري الحفظ...";
            autosaveIndicator.classList.add("saving");
            
            // جدولة الحفظ التلقائي بعد فترة زمنية محددة
            autoSaveTimer = setTimeout(() => {
                saveSettings(true);
                autoSaveTimer = null;
            }, AUTO_SAVE_DELAY);
        }

        // دالة لتنسيق التاريخ والوقت
        function formatDateTime(date) {
            const options = { 
                year: 'numeric', 
                month: 'numeric', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit' 
            };
            return date.toLocaleString('ar-SA', options);
        }

        // أحداث للاستماع للتغييرات
        titleText.addEventListener('input', updatePreview);
        titleFont.addEventListener('change', updatePreview);
        titleSize.addEventListener('input', updatePreview);
        titleColor.addEventListener('change', updatePreview);
        titleBold.addEventListener('change', updatePreview);
        titleItalic.addEventListener('change', updatePreview);
        titleUnderline.addEventListener('change', updatePreview);
        titleAlignRadios.forEach(radio => radio.addEventListener('change', updatePreview));

        productText.addEventListener('input', updatePreview);
        productFont.addEventListener('change', updatePreview);
        productSize.addEventListener('input', updatePreview);
        productColor.addEventListener('change', updatePreview);
        productBold.addEventListener('change', updatePreview);
        productItalic.addEventListener('change', updatePreview);
        productUnderline.addEventListener('change', updatePreview);
        productAlignRadios.forEach(radio => radio.addEventListener('change', updatePreview));

        priceText.addEventListener('input', updatePreview);
        priceFont.addEventListener('change', updatePreview);
        priceSize.addEventListener('input', updatePreview);
        priceColor.addEventListener('change', updatePreview);
        priceBold.addEventListener('change', updatePreview);
        priceItalic.addEventListener('change', updatePreview);
        priceUnderline.addEventListener('change', updatePreview);
        priceAlignRadios.forEach(radio => radio.addEventListener('change', updatePreview));

        backgroundOpacity.addEventListener('input', updatePreview);
        orientationRadios.forEach(radio => radio.addEventListener('change', updatePreview));

        // استيراد صورة الخلفية
        backgroundImage.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    backgroundImageData = event.target.result;
                    previewBackground.style.backgroundImage = `url(${backgroundImageData})`;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        });

        // أحداث معاينة الطباعة والطباعة
        printBtn.addEventListener('click', showPrintPreview);
        closePreviewBtn.addEventListener('click', closePrintPreview);
        printNowBtn.addEventListener('click', function() {
            printDocument();
            closePrintPreview();
        });

        // عرض رسالة 
        function showMessage(message) {
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // دالة لحفظ الإعدادات
        function saveSettings(isAutoSave = false) {
            const settings = {
                title: {
                    text: titleText.value,
                    font: titleFont.value,
                    size: titleSize.value,
                    color: titleColor.value,
                    bold: titleBold.checked,
                    italic: titleItalic.checked,
                    underline: titleUnderline.checked,
                    align: getSelectedRadioValue(titleAlignRadios)
                },
                product: {
                    text: productText.value,
                    font: productFont.value,
                    size: productSize.value,
                    color: productColor.value,
                    bold: productBold.checked,
                    italic: productItalic.checked,
                    underline: productUnderline.checked,
                    align: getSelectedRadioValue(productAlignRadios)
                },
                price: {
                    text: priceText.value,
                    font: priceFont.value,
                    size: priceSize.value,
                    color: priceColor.value,
                    bold: priceBold.checked,
                    italic: priceItalic.checked,
                    underline: priceUnderline.checked,
                    align: getSelectedRadioValue(priceAlignRadios)
                },
                background: {
                    imageData: backgroundImageData,
                    opacity: backgroundOpacity.value
                },
                orientation: getSelectedRadioValue(orientationRadios),
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('pageSettings', JSON.stringify(settings));
            
            // تحديث وقت الحفظ التلقائي وعرضه
            lastAutoSaveTime = new Date();
            if (isAutoSave) {
                autosaveIndicator.textContent = `آخر حفظ تلقائي: ${formatDateTime(lastAutoSaveTime)}`;
                autosaveIndicator.classList.remove("saving");
            } else {
                showMessage('تم حفظ الإعدادات بنجاح');
                autosaveIndicator.textContent = `آخر حفظ تلقائي: ${formatDateTime(lastAutoSaveTime)}`;
                autosaveIndicator.classList.remove("saving");
            }
        }

        // دالة لاسترجاع الإعدادات
        function loadSettings() {
            const settingsJson = localStorage.getItem('pageSettings');
            if (!settingsJson) {
                showMessage('لا توجد إعدادات محفوظة');
                return;
            }
            
            const settings = JSON.parse(settingsJson);
            
            // استرجاع إعدادات العنوان
            titleText.value = settings.title.text;
            titleFont.value = settings.title.font;
            titleSize.value = settings.title.size;
            titleColor.value = settings.title.color;
            titleBold.checked = settings.title.bold;
            titleItalic.checked = settings.title.italic;
            titleUnderline.checked = settings.title.underline;
            setSelectedRadioValue(titleAlignRadios, settings.title.align);
            
            // استرجاع إعدادات المنتج
            productText.value = settings.product.text;
            productFont.value = settings.product.font;
            productSize.value = settings.product.size;
            productColor.value = settings.product.color;
            productBold.checked = settings.product.bold;
            productItalic.checked = settings.product.italic;
            productUnderline.checked = settings.product.underline;
            setSelectedRadioValue(productAlignRadios, settings.product.align);
            
            // استرجاع إعدادات السعر
            priceText.value = settings.price.text;
            priceFont.value = settings.price.font;
            priceSize.value = settings.price.size;
            priceColor.value = settings.price.color;
            priceBold.checked = settings.price.bold;
            priceItalic.checked = settings.price.italic;
            priceUnderline.checked = settings.price.underline;
            setSelectedRadioValue(priceAlignRadios, settings.price.align);
            
            // استرجاع إعدادات الخلفية
            backgroundImageData = settings.background.imageData;
            if (backgroundImageData) {
                previewBackground.style.backgroundImage = `url(${backgroundImageData})`;
            }
            backgroundOpacity.value = settings.background.opacity;
            
            // استرجاع اتجاه الصفحة
            setSelectedRadioValue(orientationRadios, settings.orientation);
            
            // تحديث المعاينة
            updatePreview();
            
            // تحديث مؤشر آخر حفظ
            if (settings.lastSaved) {
                lastAutoSaveTime = new Date(settings.lastSaved);
                autosaveIndicator.textContent = `آخر حفظ تلقائي: ${formatDateTime(lastAutoSaveTime)}`;
            }
            
            showMessage('تم استرجاع الإعدادات بنجاح');
        }
        
        // مساعد للحصول على قيمة الراديو المحدد
        function getSelectedRadioValue(radios) {
            for (const radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return null;
        }
        
        // مساعد لتعيين قيمة الراديو المحدد
        function setSelectedRadioValue(radios, value) {
            for (const radio of radios) {
                radio.checked = (radio.value === value);
            }
        }
        
        // إضافة أحداث للأزرار
        saveBtn.addEventListener('click', () => saveSettings(false));
        loadBtn.addEventListener('click', loadSettings);

        // تحميل الإعدادات المحفوظة عند تحميل الصفحة
        window.addEventListener('load', function() {
            // محاولة تحميل الإعدادات المحفوظة
            const settingsJson = localStorage.getItem('pageSettings');
            if (settingsJson) {
                loadSettings();
            } else {
                // إذا لم تكن هناك إعدادات محفوظة، استخدام الإعدادات الافتراضية والحفظ
                updatePreview();
                saveSettings(true);
            }
        });
        
        // تنفيذ التحديث الأولي
        updatePreview();
    </script>
</body>
</html>
